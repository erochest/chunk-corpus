!function(n){"use strict";zip.workerScriptsPath="/chunk-corpus/scripts/";var t=/[\w'-–—]*\w/g,r=function(n,t,r){for(var e=[n],a=n.length;t>a;)e.push(r),a+=r.length;return e.reverse().join("")},e=function(n,t){var e=/^(.+)\.[^.]*$/,a=n.replace(e,"$1"),o=r(t.toString(),6,"0");return a+"-"+o+".txt"},a=function(n){return n.name=e(n.name,n.contents.start),n},o=function(n){return n.match(t)},u=function(n,t,r){var e=[],a=0;if(n.length<t)e.push(n);else for(;a<=n.length;)e.push({start:a,data:n.slice(a,a+t)}),a+=r;return e},i=function(n){return Bacon.fromCallback(function(t){var r=new FileReader;r.onload=function(r){t({name:n.name,contents:r.target.result})},r.readAsText(n)})},c=function(t,r,e,a){if(e<r.length){var o=r[e];t.add(o.name,new zip.TextReader(o.contents),function(){var o=n("#chunk_progress");c(t,r,e+1,a),o.attr("value",1+parseInt(o.attr("value")))})}else a(t)},l=function(n){return Bacon.fromCallback(function(t){zip.createWriter(new zip.BlobWriter,function(r){c(r,n,0,t)})})},f=function(n){return Bacon.fromCallback(function(t){n.close(t)})},s=function(n){saveAs(n,"corpus-chunks.zip")},p=function(n,t){return function(r){return r[n]=t(r[n]),r}},g=function(n){return function(t){for(var r=t[n].slice(),e=Object.getOwnPropertyNames(t),a=0;a<r.length;a++){for(var o={},u=0;u<e.length;u++){var i=e[u];o[i]=t[i]}o[n]=r[a],r[a]=o}return Bacon.fromArray(r)}},d=function(t,r){return function(e){return Bacon.sequentially(0,e).filter(function(n){return"text/plain"===n.type}).flatMap(i).map(p("contents",o)).map(p("contents",function(e){var a=u(e,t,r),o=n("#chunk_progress");return o.attr("max",a.length+parseInt(o.attr("max"))-1),a})).flatMap(g("contents")).map(a).map(p("contents",function(n){return n.data.join(" ")})).fold([],function(n,t){return n.push(t),n}).filter(function(n){return n.length>0}).flatMap(l).flatMap(f)}};n(function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var t=n("#input_files"),r=n("#drop_target"),e=parseInt(n("#chunk_size").val()),a=parseInt(n("#chunk_step").val()),o=null,u=null,i=null,c=null;o=t.asEventStream("change"),i=o.flatMap(function(n){return n.target.files}),r.on("dragover",function(n){n.stopPropagation(),n.preventDefault(),n.originalEvent.dataTransfer.dropEffect="copy"}),u=r.asEventStream("drop").doAction(function(n){n.stopPropagation(),n.preventDefault()}),c=u.flatMap(function(n){return n.originalEvent.dataTransfer.files}),Bacon.mergeAll(i,c).map(function(t){return n("#progress_modal").openModal(),n("#chunk_progress").attr("max",t.length).attr("value",0),t}).flatMap(d(e,a)).onValue(function(t){s(t),n("#progress_modal").closeModal()})}else n("#error_modal").openModal()})}(jQuery);